## Правила проекта (MiniApp TG)

### 1) Приватность и хранение данных
- Фото камеры/медиатеки не сохраняются локально и не отправляются на сервер.
- Не используем IndexedDB/LocalStorage для кэша изображений (кроме отладочных метрик).
- Playwright‑тесты не сохраняют видео/скриншоты по умолчанию.

### 2) Доступы и UX
- Запрос камеры только по нажатию на «затвор». При входе доступы не запрашиваем.
- Выбор из медиатеки открываем системным пикером (без `capture`), по кнопке «Выбрать изображение».
- Отображаем только подсветку на исходном изображении (серые блоки поверх текста). Текст не выводим отдельным блоком.

### 3) OCR и подсветка
- Языки по умолчанию: `eng+rus`.
- Если `words` пусты — используем фоллбек: `lines` → `paragraphs` → `blocks` (их bbox тоже подсвечиваем).
- Подсветка рисуется на `overlay`‑canvas поверх изображения; учитываем `devicePixelRatio`, слой `z-index: 2`.
- Перерисовка подсветки при: загрузке изображения (onLoad), смене размеров (ResizeObserver), изменении bbox.

### 4) Отладка и тестовые режимы
- `?mockOcr=1` — мок‑OCR с фиксированными bbox (детерминированные тесты/демо).
- `?test=1` — выставляем метрики в `window.__overlayDebug` и `data-*` для e2e.
- `?debug=1` — показываем в UI маленький статус: `words`, размер изображения.

### 5) Тесты (Playwright)
- Запуск: `npm run test:e2e`.
- Гейт перед деплоем: как минимум один мок‑тест должен проходить (проверка, что на `overlay` есть непрозрачные пиксели).
- Интеграционный тест с реальным OCR допускается как «дымовой» (может быть медленнее/нестабилен в CI на некоторых фикстурах). При падении расследуем, но деплой блокируем только если мок‑тест не прошёл.
- Политика артефактов: видео/скрин — `off` по умолчанию. Включать вручную через переменную окружения/локальные изменения конфига.

### 6) Сборка и деплой
- Сборка: `npm run build` (Vite + TypeScript).
- Перед деплоем обязательно: `npm run test:e2e` (минимум мок‑тест).
- Деплой (Cloudflare Pages): `wrangler pages deploy dist`.

### 7) Телеграм‑интеграция
- Кнопка Web App у бота указывает на постоянный домен Pages.
- Домены должны быть разрешены у BotFather.

### 8) Таймауты и долгие операции
- Долгие процессы (dev‑сервер, туннели, симуляторы) — только в фоне.
- Обновление статуса через 2 минуты ожидания; жёсткий таймаут 10 минут — прерываем, диагностируем причину.
- Команды должны быть неинтерактивными (где возможно).

### 9) Браузер по умолчанию для логинов
- Для внешних авторизаций/ссылок используем Яндекс.Браузер (локальное правило окружения разработчика).

### 10) Регрессии «нет подсветки» — чек‑лист
- Проверить, что `overlay` виден и поверх (z-index, opacity).
- Проверить `wordsCount` в `data-*` или `window.__overlayDebug` (включить `?test=1` или `?debug=1`).
- Если `wordsCount=0` — попробовать другую фикстуру/языки (`eng+rus+srp_latn`), проверить, что изображение читаемо (контраст/разрешение).
- Если `wordsCount>0`, но блоков не видно — проверить размеры canvas (DPR, ширина/высота, совпадение с блоком изображения).


